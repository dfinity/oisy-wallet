<script lang="ts">
	import type { WizardStep } from '@dfinity/gix-components';
	import { isNullish, nonNullish } from '@dfinity/utils';
	import { createEventDispatcher, getContext, setContext } from 'svelte';
	import BtcConvertForm from '$btc/components/convert/BtcConvertForm.svelte';
	import BtcConvertProgress from '$btc/components/convert/BtcConvertProgress.svelte';
	import BtcConvertReview from '$btc/components/convert/BtcConvertReview.svelte';
	import UtxosFeeContext from '$btc/components/fee/UtxosFeeContext.svelte';
	import { sendBtc } from '$btc/services/btc-send.services';
	import {
		UTXOS_FEE_CONTEXT_KEY,
		type UtxosFeeContext as UtxosFeeContextType,
		initUtxosFeeStore
	} from '$btc/stores/utxos-fee.store';
	import { btcAddressStore } from '$icp/stores/btc.store';
	import ButtonBack from '$lib/components/ui/ButtonBack.svelte';
	import ButtonCancel from '$lib/components/ui/ButtonCancel.svelte';
	import {
		btcAddressMainnet,
		btcAddressRegtest,
		btcAddressTestnet
	} from '$lib/derived/address.derived';
	import { authIdentity } from '$lib/derived/auth.derived';
	import { ProgressStepsConvert } from '$lib/enums/progress-steps';
	import { WizardStepsConvert } from '$lib/enums/wizard-steps';
	import { nullishSignOut } from '$lib/services/auth.services';
	import { CONVERT_CONTEXT_KEY, type ConvertContext } from '$lib/stores/convert.store';
	import { i18n } from '$lib/stores/i18n.store';
	import { toastsError } from '$lib/stores/toasts.store';
	import type { NetworkId } from '$lib/types/network';
	import type { OptionAmount } from '$lib/types/send';
	import { invalidAmount, isNullishOrEmpty } from '$lib/utils/input.utils';
	import {
		isNetworkIdBTCRegtest,
		isNetworkIdBTCTestnet,
		mapNetworkIdToBitcoinNetwork
	} from '$lib/utils/network.utils';

	export let currentStep: WizardStep | undefined;
	export let sendAmount: OptionAmount;
	export let receiveAmount: number | undefined;
	export let convertProgressStep: string;
	export let formCancelAction: 'back' | 'close' = 'close';

	const utxosFeeStore = initUtxosFeeStore();

	setContext<UtxosFeeContextType>(UTXOS_FEE_CONTEXT_KEY, {
		store: utxosFeeStore
	});

	const { sourceToken, destinationToken } = getContext<ConvertContext>(CONVERT_CONTEXT_KEY);

	const progress = (step: ProgressStepsConvert) => (convertProgressStep = step);

	let amountError: boolean;

	let networkId: NetworkId | undefined = undefined;
	$: networkId = $sourceToken.network.id;

	let sourceAddress: string;
	$: sourceAddress =
		(isNetworkIdBTCTestnet(networkId)
			? $btcAddressTestnet
			: isNetworkIdBTCRegtest(networkId)
				? $btcAddressRegtest
				: $btcAddressMainnet) ?? '';

	let destinationAddress: string | undefined = undefined;
	// BTC address generated by the ckBTC minter which needs to be used for BTC -> ckBTC conversion
	// Docs: https://github.com/dfinity/ic/blob/master/rs/bitcoin/ckbtc/minter/README.adoc#bitcoin-to-ckbtc
	$: destinationAddress = $btcAddressStore?.[$destinationToken.id]?.data;

	const dispatch = createEventDispatcher();

	const convert = async () => {
		const network = nonNullish(networkId) ? mapNetworkIdToBitcoinNetwork(networkId) : undefined;

		if (isNullish($authIdentity)) {
			await nullishSignOut();
			return;
		}

		// The data has been already validated in the previous conversion flow steps.
		if (
			isNullish(network) ||
			isNullishOrEmpty(destinationAddress) ||
			invalidAmount(sendAmount) ||
			isNullish(sendAmount) ||
			isNullish($utxosFeeStore?.utxosFee)
		) {
			toastsError({
				msg: { text: $i18n.convert.error.unexpected_missing_data }
			});
			return;
		}

		dispatch('icNext');

		try {
			// TODO: add tracking
			await sendBtc({
				destination: destinationAddress,
				amount: sendAmount,
				utxosFee: $utxosFeeStore.utxosFee,
				network,
				source: sourceAddress,
				identity: $authIdentity,
				onProgress: () => {
					if (convertProgressStep === ProgressStepsConvert.INITIALIZATION) {
						progress(ProgressStepsConvert.CONVERT);
					} else if (convertProgressStep === ProgressStepsConvert.CONVERT) {
						progress(ProgressStepsConvert.UPDATE_UI);
					}
				}
			});

			progress(ProgressStepsConvert.DONE);

			setTimeout(() => close(), 750);
		} catch (err: unknown) {
			toastsError({
				msg: { text: $i18n.convert.error.unexpected },
				err
			});

			back();
		}
	};

	const close = () => dispatch('icClose');
	const back = () => dispatch('icBack');
</script>

<UtxosFeeContext amount={sendAmount} {networkId} {amountError}>
	{#if currentStep?.name === WizardStepsConvert.CONVERT}
		<BtcConvertForm
			on:icNext
			on:icClose
			bind:sendAmount
			bind:receiveAmount
			bind:amountError
			source={sourceAddress}
		>
			<svelte:fragment slot="cancel">
				{#if formCancelAction === 'back'}
					<ButtonBack on:click={back} />
				{:else}
					<ButtonCancel on:click={close} />
				{/if}
			</svelte:fragment>
		</BtcConvertForm>
	{:else if currentStep?.name === WizardStepsConvert.REVIEW}
		<BtcConvertReview on:icConvert={convert} on:icBack {sendAmount} {receiveAmount}
			><ButtonBack slot="cancel" on:click={back} /></BtcConvertReview
		>
	{:else if currentStep?.name === WizardStepsConvert.CONVERTING}
		<BtcConvertProgress bind:convertProgressStep />
	{:else}
		<slot />
	{/if}
</UtxosFeeContext>
