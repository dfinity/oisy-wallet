<script lang="ts">
	import { isNullish, nonNullish } from '@dfinity/utils';
	import BtcTransactionModal from '$btc/components/transactions/BtcTransactionModal.svelte';
	import { btcTransactionsStore } from '$btc/stores/btc-transactions.store';
	import type { BtcTransactionUi } from '$btc/types/btc';
	import EthTransactionModal from '$eth/components/transactions/EthTransactionModal.svelte';
	import { ethTransactionsStore } from '$eth/stores/eth-transactions.store';
	import type { EthTransactionUi } from '$eth/types/eth-transaction';
	import IcTransactionModal from '$icp/components/transactions/IcTransactionModal.svelte';
	import { btcStatusesStore } from '$icp/stores/btc.store';
	import { icTransactionsStore } from '$icp/stores/ic-transactions.store';
	import type { IcTransactionUi } from '$icp/types/ic-transaction';
	import { ckEthMinterInfoStore } from '$icp-eth/stores/cketh.store';
	import AllTransactionsSkeletons from '$lib/components/transactions/AllTransactionsSkeletons.svelte';
	import TransactionsDateGroup from '$lib/components/transactions/TransactionsDateGroup.svelte';
	import TransactionsPlaceholder from '$lib/components/transactions/TransactionsPlaceholder.svelte';
	import { ethAddress } from '$lib/derived/address.derived';
	import {
		modalBtcTransaction,
		modalEthTransaction,
		modalIcTransaction,
		modalSolTransaction
	} from '$lib/derived/modal.derived';
	import { enabledNetworkTokens } from '$lib/derived/network-tokens.derived';
	import { modalStore } from '$lib/stores/modal.store';
	import type { OptionToken } from '$lib/types/token';
	import type { AllTransactionUiWithCmp, TransactionsUiDateGroup } from '$lib/types/transaction';
	import { groupTransactionsByDate, mapTransactionModalData } from '$lib/utils/transaction.utils';
	import { mapAllTransactionsUi, sortTransactions } from '$lib/utils/transactions.utils';
	import SolTransactionModal from '$sol/components/transactions/SolTransactionModal.svelte';
	import { solTransactionsStore } from '$sol/stores/sol-transactions.store';
	import type { SolTransactionUi } from '$sol/types/sol-transaction';

	let transactions: AllTransactionUiWithCmp[];
	$: transactions = mapAllTransactionsUi({
		tokens: $enabledNetworkTokens,
		$btcTransactions: $btcTransactionsStore,
		$ethTransactions: $ethTransactionsStore,
		$ckEthMinterInfo: $ckEthMinterInfoStore,
		$ethAddress: $ethAddress,
		$icTransactions: $icTransactionsStore,
		$btcStatuses: $btcStatusesStore,
		$solTransactions: $solTransactionsStore
	});

	let sortedTransactions: AllTransactionUiWithCmp[];
	$: sortedTransactions = transactions.sort(({ transaction: a }, { transaction: b }) =>
		sortTransactions({ transactionA: a, transactionB: b })
	);

	let groupedTransactions: TransactionsUiDateGroup<AllTransactionUiWithCmp> | undefined;
	$: groupedTransactions = nonNullish(sortedTransactions)
		? groupTransactionsByDate(sortedTransactions)
		: undefined;

	let selectedBtcTransaction: BtcTransactionUi | undefined;
	let selectedBtcToken: OptionToken;
	$: ({ transaction: selectedBtcTransaction, token: selectedBtcToken } =
		mapTransactionModalData<BtcTransactionUi>({
			$modalOpen: $modalBtcTransaction,
			$modalStore: $modalStore
		}));

	let selectedEthTransaction: EthTransactionUi | undefined;
	let selectedEthToken: OptionToken;
	$: ({ transaction: selectedEthTransaction, token: selectedEthToken } =
		mapTransactionModalData<EthTransactionUi>({
			$modalOpen: $modalEthTransaction,
			$modalStore: $modalStore
		}));

	let selectedIcTransaction: IcTransactionUi | undefined;
	let selectedIcToken: OptionToken;
	$: ({ transaction: selectedIcTransaction, token: selectedIcToken } =
		mapTransactionModalData<IcTransactionUi>({
			$modalOpen: $modalIcTransaction,
			$modalStore: $modalStore
		}));

	let selectedSolTransaction: SolTransactionUi | undefined;
	let selectedSolToken: OptionToken;
	$: ({ transaction: selectedSolTransaction, token: selectedSolToken } =
		mapTransactionModalData<SolTransactionUi>({
			$modalOpen: $modalSolTransaction,
			$modalStore: $modalStore
		}));
</script>

<AllTransactionsSkeletons>
	{#if nonNullish(groupedTransactions) && sortedTransactions.length > 0}
		{#each Object.entries(groupedTransactions) as [date, transactions] (date)}
			<TransactionsDateGroup {date} {transactions} />
		{/each}
	{/if}

	{#if isNullish(groupedTransactions) || sortedTransactions.length === 0}
		<TransactionsPlaceholder />
	{/if}
</AllTransactionsSkeletons>

{#if $modalBtcTransaction && nonNullish(selectedBtcTransaction)}
	<BtcTransactionModal transaction={selectedBtcTransaction} token={selectedBtcToken} />
{:else if $modalEthTransaction && nonNullish(selectedEthTransaction)}
	<EthTransactionModal transaction={selectedEthTransaction} token={selectedEthToken} />
{:else if $modalIcTransaction && nonNullish(selectedIcTransaction)}
	<IcTransactionModal transaction={selectedIcTransaction} token={selectedIcToken} />
{:else if $modalSolTransaction && nonNullish(selectedSolTransaction)}
	<SolTransactionModal transaction={selectedSolTransaction} token={selectedSolToken} />
{/if}
