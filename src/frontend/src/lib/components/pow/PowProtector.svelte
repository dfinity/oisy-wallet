<script lang="ts">
	import { Modal, themeStore } from '@dfinity/gix-components';
	import { onDestroy, onMount, type Snippet } from 'svelte';
	import { get } from 'svelte/store';
	import { POW_FEATURE_ENABLED } from '$env/pow.env';
	import { initPowProtectorWorker } from '$icp/services/worker.pow-protection.services';
	import type { PowProtectorWorkerInitResult } from '$icp/types/pow-protector-listener';
	import ImgBanner from '$lib/components/ui/ImgBanner.svelte';
	import InProgress from '$lib/components/ui/InProgress.svelte';
	import { powProtectorSteps } from '$lib/config/pow.config';
	import { CHECK_INTERVAL_MS, MAX_CHECK_ATTEMPTS } from '$lib/constants/pow.constants';
	import { ProgressStepsPowProtectorLoader } from '$lib/enums/progress-steps';
	import { errorSignOut } from '$lib/services/auth.services';
	import { handleInsufficientCycles } from '$lib/services/loader.services';
	import { i18n } from '$lib/stores/i18n.store';
	import { powProtectoreProgressStore } from '$lib/stores/pow-protection.store';
	import { replaceOisyPlaceholders, replacePlaceholders } from '$lib/utils/i18n.utils';

	interface Props {
		children?: Snippet;
	}

	let { children }: Props = $props();

	// Use let with $state() for variables that need to be reassigned
	let hasCycles = $state(false);
	let loading = $state(false);
	let checkInterval = $state<NodeJS.Timeout | undefined>();
	let checkAttempts = $state(0);
	let powWorker = $state<PowProtectorWorkerInitResult | undefined>();

	// Initialize with default value, but it will be reactively updated from the store
	let progressStep = $state(ProgressStepsPowProtectorLoader.REQUEST_CHALLENGE);

	// Subscribe to the store and update progressStep reactively
	$effect(() => {
		const progressStoreData = $powProtectoreProgressStore;
		if (progressStoreData?.progress) {
			switch (progressStoreData.progress) {
				case 'REQUEST_CHALLENGE':
					progressStep = ProgressStepsPowProtectorLoader.REQUEST_CHALLENGE;
					break;
				case 'SOLVE_CHALLENGE':
					progressStep = ProgressStepsPowProtectorLoader.SOLVE_CHALLENGE;
					break;
				case 'GRANT_CYCLES':
					progressStep = ProgressStepsPowProtectorLoader.GRANT_CYCLES;
					break;
				default:
					// Fallback to initialization if unknown value
					console.error('Unknown value: ', progressStoreData.progress);
			}
		}
	});

	// Using $derived for reactive steps array from config
	let steps = $derived(powProtectorSteps({ i18n: $i18n }));

	/**
	 * Is periodically checks if the user has sufficient cycles for POW protection.
	 * It will either clear the interval when cycles are sufficient, or sign out the user
	 * if maximum retry attempts are exceeded.
	 */
	const checkCycles = async (): Promise<void> => {
		try {
			// Check current cycles status and update the reactive state
			hasCycles = await handleInsufficientCycles();

			// Increment attempt counter to track how many times we've checked
			checkAttempts++;

			if (hasCycles) {
				// Success: User now has sufficient cycles, stop polling
				if (checkInterval) {
					clearInterval(checkInterval);
					checkInterval = undefined;
				}
			} else if (checkAttempts >= MAX_CHECK_ATTEMPTS) {
				// Failure: Too many failed attempts, clean up and sign out user
				if (checkInterval) {
					clearInterval(checkInterval);
					checkInterval = undefined;
				}
				// Sign out with appropriate error message about cycle waiting timeout
				await errorSignOut(get(i18n).init.error.waiting_for_allowed_cycles_aborted);
			}
		} catch (error) {
			// Log error but continue polling (network issues shouldn't stop the process)
			console.error('Error checking cycles:', error);
			checkAttempts++;
		}
	};

	const initWorker = async (): Promise<void> => {
		if (!powWorker) {
			try {
				// Run the worker in the background that continuously checks if the user has sufficient cycles and requests/solves
				// a challenge to grant cycles when needed
				powWorker = await initPowProtectorWorker();
				powWorker.start();
			} catch (error) {
				// Log error but don't crash
				console.error('Failed to initialize POW worker:', error);
			}
		}
	};

	onMount(async () => {
		if (POW_FEATURE_ENABLED) {
			try {
				// Initial check
				hasCycles = await handleInsufficientCycles();
			} catch (error) {
				// Log error but continue (assume no cycles on error)
				console.error('Error checking initial cycles:', error);
				hasCycles = false;
			}

			loading = true;

			// Always initialize the worker regardless of cycles status
			await initWorker();

			if (!hasCycles) {
				// If the user does not have the required cycles amount granted, we need to poll until he has
				checkInterval = setInterval(checkCycles, CHECK_INTERVAL_MS);
			}
		}
	});

	onDestroy(() => {
		if (POW_FEATURE_ENABLED) {
			// Clear interval if component is destroyed
			if (checkInterval) {
				clearInterval(checkInterval);
				checkInterval = undefined;
			}

			// Stop the worker if it was started
			if (powWorker) {
				powWorker.destroy();
			}
		}
	});
</script>

{#if !POW_FEATURE_ENABLED}
	<!-- POW feature is globally disabled. So we bypass all protection logic and render the app content directly -->
	{@render children?.()}
{:else if hasCycles}
	<!-- User has sufficient cycles so, user can proceed normally -->
	{@render children?.()}
{:else if loading}
	<!-- 
		POW feature is enabled but user lacks sufficient cycles for POW, so we display modal with progress indicator while cycles are being obtained
		This modal will be displayed until either:
		- User obtains sufficient cycles (checkCycles polling succeeds)
		- Maximum retry attempts reached (user gets signed out)
	-->
	<div class="insufficient-cycles-modal">
		<Modal testId="pow-protector-modal">
			<div class="stretch">
				<div class="banner-container mb-8 block">
					{#await import(`$lib/assets/banner-${$themeStore ?? 'light'}.svg`) then { default: src }}
						<ImgBanner
							alt={replacePlaceholders(replaceOisyPlaceholders($i18n.init.alt.loader_banner), {
								$theme: $themeStore ?? 'light'
							})}
							{src}
							styleClass="aspect-auto"
						/>
					{/await}
				</div>

				<h3 class="my-3">{$i18n.pow_protector.text.title}</h3>
				<p class="mt-3">{$i18n.pow_protector.text.description}</p>

				<InProgress {progressStep} {steps} />
			</div>
		</Modal>
	</div>
{/if}

<style lang="scss">
	:root:has(.insufficient-cycles-modal) {
		--alert-max-width: 90vw;
		--alert-max-height: initial;
		--dialog-border-radius: calc(var(--border-radius-sm) * 3);
	}

	.banner-container {
		width: 100%;
	}
</style>
